{"version":3,"file":"remote-file-monitor.esm.js","sources":["../src/util.ts","../src/index.ts"],"sourcesContent":["import { WorkerConfig } from './interface';\n\nexport const startFileMonitorWorker = (config: Required<WorkerConfig>) => {\n  const worker = createWorker(createWorkerFunc);\n  worker.onmessage = event => {\n    const { hasUpdate } = event.data;\n    if (hasUpdate) {\n      notifyToUser(\n        config.notification.title,\n        config.notification.options,\n        config.clickCallback\n      );\n    }\n  };\n  worker.postMessage({\n    checkFileUrl: config.checkFileUrl,\n    loopMs: config.loopMs,\n    getVisibilityState: () => {\n      return document.visibilityState;\n    }\n  });\n};\n\nexport const createWorker = (func: () => void) => {\n  const blob = new Blob(['(' + func.toString() + ')()']);\n  const url = window.URL.createObjectURL(blob);\n  const worker = new Worker(url);\n  return worker;\n};\n\nexport const createWorkerFunc = () => {\n  let previousValue: string | null = null;\n  const ctx: Worker = self as any;\n  ctx.onmessage = function(event: any) {\n    const { checkFileUrl, loopMs, getVisibilityState } = event.data;\n    const clearTimer = setInterval(() => {\n      console.log(getVisibilityState(), 'document.visibilityState');\n\n      if (getVisibilityState() === 'visible') {\n        fetch(checkFileUrl, { method: 'HEAD' })\n          .then(\n            response =>\n              response.headers.get('ETag') ||\n              response.headers.get('Last-Modified')\n          )\n          .then(changeFlag => {\n            if (!changeFlag) {\n              console.log(`Can't get the change flag`);\n              clearInterval(clearTimer);\n              return;\n            }\n\n            if (previousValue === null) {\n              previousValue = changeFlag;\n            } else if (previousValue !== changeFlag) {\n              previousValue = changeFlag;\n              ctx.postMessage({\n                hasUpdate: true,\n              });\n            } else {\n              ctx.postMessage({\n                hasUpdate: false,\n              });\n            }\n          })\n          .catch(error => {\n            console.error(error);\n            clearInterval(clearTimer);\n          });\n      }\n    }, loopMs);\n  };\n  return ctx;\n};\n\nconst notifyToUser = (\n  title: string,\n  options: NotificationOptions,\n  callback: () => void\n) => {\n  if (window.Notification) {\n    try {\n      if (Notification.permission === 'granted') {\n        notifyAction(title, options, callback);\n      } else if (Notification.permission === 'default') {\n        Notification.requestPermission().then(permission => {\n          if (permission === 'granted') {\n            notifyAction(title, options, callback);\n          }\n        });\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  }\n};\n\nexport const notifyAction = (\n  title: string,\n  options: NotificationOptions,\n  callback: () => void\n) => {\n  return new Promise<void>(resolve => {\n    const notification = new Notification(title, options);\n    notification.onclick = () => {\n      notification.close();\n      callback();\n    };\n    resolve();\n  });\n};\n","import { WorkerConfig } from './interface';\nimport { startFileMonitorWorker } from './util';\n\nconst defaultConfig: Required<WorkerConfig> = {\n  loopMs: 5000,\n  enable: true,\n  checkFileUrl: `${location.origin}/index.html`,\n  notification: {\n    title: 'Page has Update!',\n    options: {\n      dir: 'auto',\n      body: 'Find upgrades, click me to update',\n      requireInteraction: true,\n    },\n  },\n  clickCallback: () => {\n    window.location.reload();\n  },\n};\n\nexport function remoteFileMonitor(config: WorkerConfig = {}) {\n  const dataItem: Required<WorkerConfig> = {\n    ...defaultConfig,\n    ...config,\n    notification: {\n      ...defaultConfig.notification,\n      ...config.notification,\n    },\n  };\n  if (dataItem.enable) {\n    if (window.Worker) {\n      Notification.requestPermission().then(permission => {\n        if (permission === 'granted') {\n          startFileMonitorWorker(dataItem);\n        }\n      });\n    } else {\n      console.log(`Your browser doesn't support web workers.`);\n    }\n  }\n}\n"],"names":["startFileMonitorWorker","config","worker","createWorker","createWorkerFunc","onmessage","event","hasUpdate","data","notifyToUser","notification","title","options","clickCallback","postMessage","checkFileUrl","loopMs","getVisibilityState","document","visibilityState","func","blob","Blob","toString","url","window","URL","createObjectURL","Worker","previousValue","ctx","self","_event$data","clearTimer","setInterval","console","log","fetch","method","then","response","headers","get","changeFlag","clearInterval","error","callback","Notification","permission","notifyAction","requestPermission","err","Promise","resolve","onclick","close","defaultConfig","enable","location","origin","dir","body","requireInteraction","reload","remoteFileMonitor","dataItem","_extends"],"mappings":"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"}