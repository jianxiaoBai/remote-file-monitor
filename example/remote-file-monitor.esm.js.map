{
  "version": 3,
  "file": "remote-file-monitor.esm.js",
  "sources": [
    "../src/util.ts",
    "../src/index.ts"
  ],
  "sourcesContent": [
    "import { WorkerConfig } from './interface';\n\nexport const startFileMonitorWorker = (config: Required<WorkerConfig>) => {\n  const worker = createWorker(createWorkerFunc);\n  worker.onmessage = event => {\n    const { hasUpdate } = event.data;\n    if (hasUpdate) {\n      notifyToUser(\n        config.notification.title,\n        config.notification.options,\n        config.clickCallback\n      );\n    }\n  };\n  worker.postMessage({\n    checkFileUrl: config.checkFileUrl,\n    loopMs: config.loopMs,\n  });\n};\n\nexport const createWorker = (func: () => void) => {\n  const blob = new Blob(['(' + func.toString() + ')()']);\n  const url = window.URL.createObjectURL(blob);\n  const worker = new Worker(url);\n  return worker;\n};\n\nexport const createWorkerFunc = () => {\n  let previousValue: string | null = null;\n  const ctx: Worker = self as any;\n  ctx.onmessage = function(event: any) {\n    const { checkFileUrl, loopMs } = event.data;\n    const clearTimer = setInterval(() => {\n      fetch(checkFileUrl, { method: 'HEAD' })\n        .then(\n          response =>\n            response.headers.get('ETag') ||\n            response.headers.get('Last-Modified')\n        )\n        .then(changeFlag => {\n          if (!changeFlag) {\n            console.log(`Can't get the change flag`);\n            clearInterval(clearTimer);\n            return;\n          }\n\n          if (previousValue === null) {\n            previousValue = changeFlag;\n          } else if (previousValue !== changeFlag) {\n            previousValue = changeFlag;\n            ctx.postMessage({\n              hasUpdate: true,\n            });\n          } else {\n            ctx.postMessage({\n              hasUpdate: false,\n            });\n          }\n        })\n        .catch(error => {\n          console.error(error);\n          clearInterval(clearTimer);\n        });\n    }, loopMs);\n  };\n  return ctx;\n};\n\nconst notifyToUser = (\n  title: string,\n  options: NotificationOptions,\n  callback: () => void\n) => {\n  if (window.Notification) {\n    try {\n      if (Notification.permission === 'granted') {\n        notifyAction(title, options, callback);\n      } else if (Notification.permission === 'default') {\n        Notification.requestPermission().then(permission => {\n          if (permission === 'granted') {\n            notifyAction(title, options, callback);\n          }\n        });\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  }\n};\n\nexport const notifyAction = (\n  title: string,\n  options: NotificationOptions,\n  callback: () => void\n) => {\n  return new Promise<void>(resolve => {\n    const notification = new Notification(title, options);\n    notification.onclick = () => {\n      notification.close();\n      callback();\n    };\n    resolve();\n  });\n};\n",
    "import { WorkerConfig } from './interface';\nimport { startFileMonitorWorker } from './util';\n\nconst defaultConfig: Required<WorkerConfig> = {\n  loopMs: 5000,\n  checkFileUrl: `${location.origin}/index.html`,\n  notification: {\n    title: 'Page has Update!',\n    options: {\n      dir: 'auto',\n      body: 'Find upgrades, click me to update',\n      requireInteraction: true,\n    },\n  },\n  clickCallback: () => {\n    window.location.reload();\n  },\n};\n\nexport function remoteFileMonitor(config: WorkerConfig = {}) {\n  const dataItem: Required<WorkerConfig> = {\n    ...defaultConfig,\n    ...config,\n    notification: {\n      ...defaultConfig.notification,\n      ...config.notification,\n    },\n  };\n\n  if (window.Worker) {\n    Notification.requestPermission().then(permission => {\n      if (permission === 'granted') {\n        startFileMonitorWorker(dataItem);\n      }\n    });\n  } else {\n    console.log(`Your browser doesn't support web workers.`);\n  }\n}\n"
  ],
  "names": [
    "startFileMonitorWorker",
    "config",
    "worker",
    "createWorker",
    "createWorkerFunc",
    "onmessage",
    "event",
    "hasUpdate",
    "data",
    "notifyToUser",
    "notification",
    "title",
    "options",
    "clickCallback",
    "postMessage",
    "checkFileUrl",
    "loopMs",
    "func",
    "blob",
    "Blob",
    "toString",
    "url",
    "window",
    "URL",
    "createObjectURL",
    "Worker",
    "previousValue",
    "ctx",
    "self",
    "_event$data",
    "clearTimer",
    "setInterval",
    "fetch",
    "method",
    "then",
    "response",
    "headers",
    "get",
    "changeFlag",
    "console",
    "log",
    "clearInterval",
    "error",
    "callback",
    "Notification",
    "permission",
    "notifyAction",
    "requestPermission",
    "err",
    "Promise",
    "resolve",
    "onclick",
    "close",
    "defaultConfig",
    "location",
    "origin",
    "dir",
    "body",
    "requireInteraction",
    "reload",
    "remoteFileMonitor",
    "dataItem",
    "_extends"
  ],
  "mappings": "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"
}
